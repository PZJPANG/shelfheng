{% extends "layout.html" %}

{% block title %}
Add
{% endblock %}

{% block body %}

    <style>
    button {
    padding: 12px 26px;
    font-size: clamp(14px, 2.5vw, 18px);
    font-weight: 600;
    border-radius: 12px;
    cursor: pointer;
    background: linear-gradient(180deg, var(--gold), var(--gold-700));
    border: 1px solid #c99823;
    color: #141414;
    margin-top: 18px;
    box-shadow: 0 4px 12px rgba(0,0,0,.25);
    transition: transform 0.1s ease, filter 0.2s ease;
    }

    @media (max-width: 768px) {
      button {
        padding: 10px 20px;
        font-size: 16px;
      }
    }

    @media (max-width: 480px) {
      button {
        padding: 8px 16px;
        font-size: 14px;
        width: 100%;
      }
    }
    button:hover {
    filter: brightness(1.05);
    transform: translateY(-1px);
    }
        input, select {
    width: 100%;
    font-size: clamp(14px, 2.5vw, 18px);
    padding: 12px 14px;
    margin: 12px 0;
    border-radius: 10px;
    border: 1px solid #2a2a31;
    background: #1b1b1f;
    color: #ececf3;
    box-sizing: border-box;
    }

    @media (max-width: 768px) {
      input, select {
        padding: 10px 12px;
        font-size: 16px;
      }
    }

    @media (max-width: 480px) {
      input, select {
        padding: 8px 10px;
        font-size: 14px;
      }
    }
    input:focus, select:focus {
    outline: none;
    border-color: var(--gold);
    box-shadow: 0 0 0 2px rgba(242,193,78,0.3);
    }
    .form-card {
    background: linear-gradient(180deg, #1c1c21, #141416);
    border: 1px solid #2a2a31;
    border-radius: 18px;
    box-shadow: 0 8px 24px rgba(0,0,0,.35);
    padding: 30px 40px;
    max-width: 500px;
    margin: 0 auto;
    }

    @media (max-width: 768px) {
      .form-card {
        padding: 20px 30px;
        max-width: 90%;
      }
    }

    @media (max-width: 480px) {
      .form-card {
        padding: 15px 20px;
        max-width: 95%;
        margin: 0 10px;
      }
    }
    </style>

    <h1 style="font-size: 56px; text-align:center; margin-bottom:20px; color: var(--gold);">Add Item</h1>

    <div class="form-card">
    <form action="/add" method="post">
        <input autocomplete="off" autofocus id="name" name="name" placeholder="Item Name" type="text" required>

        <select name="place" id="place" required>
        <option value="" disabled {% if not request.args.get('house') %}selected{% endif %}>Select House</option>
        {% for place in places %}
        <option value="{{ place.id }}" {% if request.args.get('house') == place.id|string %}selected{% endif %}>{{ place.name }}</option>
        {% endfor %}
        </select>
        
        {% if not places %}
        <div style="background: #2a1a1a; border: 1px solid #4d2b2b; border-radius: 8px; padding: 12px; margin: 12px 0; color: #ffd7d7; font-size: 14px;">
            <strong>No houses found!</strong> You need to add a house first before adding items. 
            <a href="/add_house" style="color: var(--gold); text-decoration: underline;">Add a new house here</a>.
        </div>
        {% else %}
        <div style="background: #1a2a1a; border: 1px solid #2b4a33; border-radius: 8px; padding: 12px; margin: 12px 0; color: #b7f7c2; font-size: 14px;">
            <strong>Tip:</strong> Don't see your house? 
            <a href="/add_house" style="color: var(--gold); text-decoration: underline;">Add a new house here</a>.
        </div>
        {% endif %}

        <select name="shelf" id="shelf" required>
        <option value="" disabled {% if not request.args.get('shelf') %}selected{% endif %}>Select Shelf</option>
        {% for shelf in shelves %}
        <option value="{{ shelf.name }}" data-place-id="{{ shelf.place_id }}" {% if request.args.get('shelf') == shelf.name %}selected{% endif %}>{{ shelf.name }}</option>
        {% endfor %}
        </select>
        
        <div id="shelf-note" style="background: #1a2a1a; border: 1px solid #2b4a33; border-radius: 8px; padding: 12px; margin: 12px 0; color: #b7f7c2; font-size: 14px; display: none;">
            <strong>Tip:</strong> Don't see the shelf you need? 
            <a href="#" id="add-shelf-link" style="color: var(--gold); text-decoration: underline;">Add a new shelf to this house</a>.
        </div>

        <p id="message"></p>
        <button type="submit" style="color:white">Add</button>
    </form>
    </div>

    <script>
        const nameInput = document.querySelector("#name");
        const placeSelect = document.querySelector("#place");
        const shelfSelect = document.querySelector("#shelf");
        const shelfNote = document.querySelector("#shelf-note");
        const addShelfLink = document.querySelector("#add-shelf-link");
        const msg = document.querySelector("#message");

        // Load shelves when house is selected
        placeSelect.addEventListener("change", async function() {
            const houseId = this.value;
            if (!houseId) {
                // Clear shelf options
                shelfSelect.innerHTML = '<option value="" disabled selected>Select Shelf</option>';
                shelfNote.style.display = 'none';
                return;
            }

            try {
                const res = await fetch(`/get_shelves/${houseId}`);
                const shelves = await res.json();
                
                // Update shelf dropdown
                shelfSelect.innerHTML = '<option value="" disabled selected>Select Shelf</option>';
                shelves.forEach(shelf => {
                    const option = document.createElement('option');
                    option.value = shelf.name;
                    option.textContent = shelf.name;
                    shelfSelect.appendChild(option);
                });

                // Show/hide shelf note
                if (shelves.length === 0) {
                    shelfNote.style.display = 'block';
                    addShelfLink.href = `/house/${houseId}/add_shelf`;
                } else {
                    shelfNote.style.display = 'block';
                    addShelfLink.href = `/house/${houseId}/add_shelf`;
                }
            } catch (error) {
                console.error('Error loading shelves:', error);
            }
        });

        async function checkName(itemName) {
        if (!itemName) { msg.textContent = ""; return; }
        const res = await fetch("/check", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ name: itemName })
        });
        let data;
        try {
        data = await res.json();              
        } catch {
        msg.textContent = "";
        msg.removeAttribute('style');
        return;
        }
        if (data.exists) {
            const place = data.place ?? "(unknown place)";
            const shelf = data.shelf ?? "(unknown shelf)";
            msg.textContent = `Alert: This item already exists in ${place} Shelf ${shelf}.`;
            msg.style.color = '#ff9999';
            msg.style.background = '#2a1a1a';
            msg.style.border = '1px solid #4d2b2b';
            msg.style.borderRadius = '8px';
            msg.style.padding = '12px';
            msg.style.margin = '12px 0';
        } else {
            msg.textContent = "";
            msg.removeAttribute('style');
        }
        }

        nameInput.addEventListener("keyup", function () {
        checkName(this.value);
        });

        // Initialize shelves if a house is already selected
        if (placeSelect.value) {
            placeSelect.dispatchEvent(new Event('change'));
        }
        
        // Show shelf note if coming from shelf interface
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('house') && urlParams.get('shelf')) {
            shelfNote.style.display = 'block';
            addShelfLink.href = `/house/${urlParams.get('house')}/add_shelf`;
        }
    </script>
{% endblock %}